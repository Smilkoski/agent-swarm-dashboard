<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Agent Swarm Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script>
        mermaid.initialize({startOnLoad: true, theme: 'dark', flowchart: {useMaxWidth: true}});
    </script>
    <style>
    .mermaid .nodeLabel {
        fill: white !important;
    }

    .mermaid .success {
        fill: #10b981 !important;
    }

.bg-graph {
  width: 100%;
  min-width: fit-content;
  max-width: 90vw;
  margin: 0 auto;
}

#mermaid-graph {
  width: 100%;
  overflow-x: auto;
}

#mermaid-graph svg {
  width: 100%;
  height: auto;
}

@media (min-width: 1024px) {
  .bg-graph {
    min-width: 1200px;
  }
  #mermaid-graph svg {
    min-width: 1000px;
  }
}

</style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">
<div class="container mx-auto p-6 max-w-7xl">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-600 bg-clip-text text-transparent">
            Agent Swarm Dashboard
        </h1>
    </div>

    <!-- Controls -->
    <div class="flex flex-wrap gap-4 mb-8">
<!--        <input type="text" id="mission-name" placeholder="Mission name..." value="Uber for Dog Walking in Rural Areas"-->
<!--        <input type="text" id="mission-name" placeholder="Mission name..." value="Corporate Conference Planning"-->
        <input type="text" id="mission-name" placeholder="Mission name..." value="2025 AI Agent Trends Report"
               class="flex-1 min-w-64 px-5 py-3 rounded-lg bg-gray-900 border border-gray-700 focus:border-purple-500 outline-none">
        <button id="start-btn"
                class="px-8 py-3 bg-gradient-to-r from-green-600 to-emerald-600 rounded-lg font-bold hover:opacity-90 transition">
            Start Mission
        </button>
        <button id="replay-btn" class="px-6 py-3 bg-gray-700 rounded-lg hidden">Replay Last Run</button>
    </div>

    <div id="status" class="text-center text-2xl mb-6 font-mono"></div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        <!-- Timeline -->
        <div class="xl:col-span-2 bg-gray-900 rounded-2xl p-6 shadow-2xl max-h-screen overflow-y-auto" id="timeline">
            <p class="text-gray-500 text-center" id="placeholder">Waiting for agents to wake up...</p>
        </div>

        <!-- Mission History -->
        <div class="bg-gray-900 rounded-2xl p-6 shadow-2xl">
          <h2 class="text-2xl font-bold mb-4 flex items-center gap-3">
            <i class="fas fa-history text-purple-400"></i>
            Mission History
          </h2>
            <div id="history-list" class="space-y-2 max-h-96 overflow-y-auto text-sm">
                {% for entry in history %}
                  <button onclick="location.href='/run/{{ entry.run_id }}'" class="block w-full text-left p-3 bg-gray-800 hover:bg-gray-700 rounded mb-2">
                    <div class="font-bold">{{ entry.name }}</div>
                    <div class="text-xs opacity-70">
                      {{ entry.started_at}} • {{ entry.tokens }} tokens
                    </div>
                  </button>
                {% empty %}
                  <div class="text-center text-gray-500 p-3">No mission history available yet.</div>
                {% endfor %}
            </div>
        </div>

        <!-- Live Graph -->
        <div class="bg-graph rounded-2xl p-6 shadow-2xl w-full min-w-fit mx-auto">
          <h2 class="text-2xl font-bold mb-4 flex items-center gap-3">
            <i class="fas fa-project-diagram text-purple-400"></i>
            Live Agent Graph
          </h2>
          <div id="mermaid-graph" class="bg-gray-950 p-6 rounded-xl overflow-x-auto w-full">
          </div>
        </div>
    </div>
    </div>

{{ messages_json|json_script:"initial-messages-data" }}

<script>
let source = null;
let tokenCount = 0;
let startTime = null;
let missionName = null;

const initialMessages = JSON.parse(
        document.getElementById('initial-messages-data').textContent
    );

let mermaidCode = `
graph TD
    Start[Swarm Ready]:::ready
    classDef ready fill:#6366f1,stroke:#4f46e5,color:white,font-weight:bold,rx:12px,ry:12px
    classDef manager fill:#8b5cf6,stroke:#7c3aed,color:white,font-weight:bold,rx:15px,ry:15px
    classDef agent fill:#1e293b,stroke:#64748b,color:#e2e8f0,rx:12px,ry:12px
    classDef success fill:#059669,stroke:#047857,color:white,font-weight:bold,rx:20px,ry:20px
`;

function renderMessages(messages) {

    if (messages === undefined || messages.length === 0)
        return;
    messages = JSON.parse(messages);

    for (let msg of messages) {
        tokenCount += countTokens(msg.content);
        $("#status").html(`<span class="text-green-400">● Live • ${tokenCount} tokens • $${(tokenCount * 0.00006).toFixed(4)}</span>`);

        updateGraph(msg.agent_name, msg.message_type);

        const color = msg.message_type === "final" ? "from-emerald-600 to-green-600" : "from-blue-900 to-indigo-900";
        $("#timeline").append(`
        <div class="mb-5 p-5 rounded-xl bg-gradient-to-r ${color} border border-gray-700 shadow-lg transform hover:scale-105 transition">
            <div class="flex justify-between items-start">
                <b class="text-xl text-yellow-300">${msg.agent_name}</b>
                <span class="text-xs opacity-70">${msg.timestamp}</span>
            </div>
            <div class="mt-3 prose prose-invert max-w-none text-white font-medium">
                ${renderMarkdown(msg.content)}
            </div>
        </div>
    `);
        $("#timeline")[0].scrollTop = $("#timeline")[0].scrollHeight;

        if (msg.message_type === "final") {
            $("#placeholder").hide();
        }

    }
}

renderMessages(initialMessages)

function updateGraph(agent, type) {
    const id = agent.replace(/[^a-zA-Z0-9]/g, '_');
    if (!mermaidCode.includes("Manager[")) {
        mermaidCode += `    Manager[Manager]:::manager\n    Start --> Manager\n`;
    }
    if (!mermaidCode.includes(`${id}[${agent}]`)) {
        mermaidCode += `    ${id}[${agent}]:::agent\n    Manager --> ${id}\n`;
    }
    if (type === "final") {
        mermaidCode += `    ${id} --> DONE[Mission Complete]:::success\n`;
    }
    document.getElementById("mermaid-graph").innerHTML = `<pre class="mermaid">${mermaidCode}</pre>`;
    mermaid.run({ nodes: [document.querySelector('#mermaid-graph .mermaid')] });
}

function countTokens(text) {
    return Math.ceil(text.length / 4);
}

function renderMarkdown(text) {
    return text
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
        .replace(/__(.*?)__/g, "<strong>$1</strong>")
        .replace(/\*(.*?)\*/g, "<em>$1</em>")
        .replace(/_(.*?)_/g, "<em>$1</em>")
        .replace(/`(.*?)`/g, "<code class='bg-black/50 px-1 rounded'>$1</code>")
        .replace(/\n/g, "<br>");
}

function connectSSE(runId, retryCount = 0) {
    if (source) source.close();

    source = new EventSource(`http://localhost:8001/stream/${runId}`);

    source.onopen = () => {
        console.log("SSE Connected:", runId);
        $("#status").html(`<span class="text-green-400">● Live • ${tokenCount} tokens</span>`);
    };

    source.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        tokenCount += countTokens(msg.content);
        $("#status").html(`<span class="text-green-400">● Live • ${tokenCount} tokens • $${(tokenCount*0.00006).toFixed(4)}</span>`);

        updateGraph(msg.agent_name, msg.type);

        const color = msg.type === "final" ? "from-emerald-600 to-green-600" : "from-blue-900 to-indigo-900";
        $("#timeline").append(`
            <div class="mb-5 p-5 rounded-xl bg-gradient-to-r ${color} border border-gray-700 shadow-lg transform hover:scale-105 transition">
                <div class="flex justify-between items-start">
                    <b class="text-xl text-yellow-300">${msg.agent_name}</b>
                    <span class="text-xs opacity-70">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="mt-3 prose prose-invert max-w-none text-white font-medium">
                    ${renderMarkdown(msg.content)}
                </div>
            </div>
        `);
        $("#timeline")[0].scrollTop = $("#timeline")[0].scrollHeight;

        if (msg.type === "final") {
            $("#placeholder").hide();
            saveToHistory(runId, missionName, tokenCount);
        }
    };

    source.onerror = () => {
        console.error("SSE Error — reconnecting...");
        const delay = Math.min(1000 * Math.pow(2, retryCount), 10000);
        setTimeout(() => connectSSE(runId, retryCount + 1), delay);
    };
}

function saveToHistory(runId, name, tokens) {
    $("#history-list").append(`
            <button onclick="location.href='/run/${runId}'" class="block w-full text-left p-3 bg-gray-800 hover:bg-gray-700 rounded mb-2">
                <div class="font-bold">${name}</div>
                <div class="text-xs opacity-70">${new Date().toLocaleDateString()} • ${tokens} tokens</div>
            </button>
        `);
}

// START MISSION
$("#start-btn").click(function () {
    let run_id = null;
    missionName = $("#mission-name").val().trim() || "New Mission";
    tokenCount = 0;
    startTime = Date.now();
    $("#status").text("Launching agents...");

    async function startMissionFlow() {
    try {
        const createRes = await $.post("/create_agent/");
        const run_id = createRes.run_id;

        connectSSE(run_id);

        // wait 1 second for subscriptions to initialize
        await new Promise(resolve => setTimeout(resolve, 2000));
        await $.post("/api/start/", JSON.stringify({name: missionName, run_id: run_id}));

        } catch (err) {
            console.error("Mission launch failed:", err);
            alert("Something went wrong. Check console.");
        }
    }

    startMissionFlow();

});

mermaid.run({ nodes: [document.querySelector('#mermaid-graph .mermaid')] });

</script>

</body>
</html>